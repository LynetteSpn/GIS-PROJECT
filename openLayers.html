<!DOCTYPE html>
<html>
<head>
    <title>OpenLayers Basemap Switcher</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css">
    <link rel="stylesheet" href="style.css"> 
</head>

<body>
    <div id="map" class="map"></div>
    
    <select id="basemap-selector" onchange="switchBasemap(this.value)">
        <option value="Regular Map">Regular (Streets)</option>
        <option value="Satellite Imagery">Satellite</option>
    </select>

    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>

    <script>
    // 1. Define Layer Sources and Layers 
    
    // 1.1 Regular/Street Basemap (OSM)
    const osmLayer = new ol.layer.Tile({ 
        source: new ol.source.OSM(),     
        visible: true,
        properties: {
            title: 'Regular Map',
            type: 'base',
        }
    });

    // 1.2 Satellite Basemap 
    const satelliteLayer = new ol.layer.Tile({ 
        source: new ol.source.XYZ({
            url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
            attributions: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
            maxZoom: 19
        }),
        visible: false, 
        properties: {
            title: 'Satellite Imagery', 
            type: 'base',
        }
    });

    // 1.3 Road Data Layer (Vector Layer) 
    const roadSource = new ol.source.Vector({
        url: 'sabah_main_roads.geojson', 
        format: new ol.format.GeoJSON() 
    });

    const roadStyle = new ol.style.Style({
        stroke: new ol.style.Stroke({
            color: 'blue', 
            width: 2
        })
    });

    const roadLayer = new ol.layer.Vector({
        source: roadSource,
        style: roadStyle,
        properties: {
            title: 'Road Data',
            type: 'data' 
        }
    });

    // --- 1.4 District Layer Source and Colors ---
    const districtSource = new ol.source.Vector({
        url: 'sabah_district.geojson', 
        format: new ol.format.GeoJSON() 
    });

    // Define the color palette
    const colors = ['#e6194b','#3cb44b','#ffe119','#4363d8','#f58231','#911eb4','#46f0f0','#f032e6'];
    
    // Helper to get consistent color based on feature name
    function getColorForFeature(feature) {
        const name = feature.get('NAME_2');
        let hash = 0;
        for (let i = 0; i < name.length; i++) {
            hash = name.charCodeAt(i) + ((hash << 5) - hash);
        }
        const index = Math.abs(hash) % colors.length;
        return colors[index];
    }

    // --- 1.5 STYLE FUNCTION FOR OSM/REGULAR MAP (Colored Fill) ---
    function osmDistrictStyle(feature) {
        const color = getColorForFeature(feature);
        const name = feature.get('NAME_2');
        
        return new ol.style.Style({
            fill: new ol.style.Fill({
                color: color + '99' 
            }),
            stroke: new ol.style.Stroke({
                color: color, 
                width: 1
            }),
            text: new ol.style.Text({
                text: name,
                font: '14px Calibri,sans-serif',
                fill: new ol.style.Fill({ color: '#000' }),
                stroke: new ol.style.Stroke({ color: '#fff', width: 2 }),
                overflow: false
            })
        });
    }

    // --- 1.6 STYLE FUNCTION FOR SATELLITE MAP (Transparent Fill, High-Contrast Text) ---
    function satelliteDistrictStyle(feature) {
        const name = feature.get('NAME_2');

        return new ol.style.Style({
            fill: new ol.style.Fill({
                color: 'rgba(0, 0, 0, 0.0)' 
            }),
            stroke: new ol.style.Stroke({
                color: '#fff', 
                width: 2 
            }),
            text: new ol.style.Text({
                text: name,
                font: '14px Calibri,sans-serif',
                fill: new ol.style.Fill({ color: '#fff' }), 
                stroke: new ol.style.Stroke({ color: '#000', width: 2 }), 
                overflow: false
            })
        });
    }


    // Create the actual district layer
    const districtLayer = new ol.layer.Vector({
        source: districtSource,
        style: osmDistrictStyle, 
        visible: true, 
        properties: {
            title: 'District Boundaries',
            type: 'data-conditional'
        }
    });


    // --- 2. Create the Map Object ---
    
    const map = new ol.Map({
        target: 'map', 
        layers: [
            osmLayer,
            satelliteLayer,
            districtLayer, 
            roadLayer      
        ], 
        view: new ol.View({
            center: ol.proj.fromLonLat([117.5, 5.0]), 
            zoom: 8
        })
    });

    // --- 3. Implement the Basemap Switching Function ---
    
    function switchBasemap(newBaseMapTitle) { 
        const layers = map.getLayers().getArray();
        
        layers.forEach(layer => {
            const layerProperties = layer.getProperties();

            // Part 1: Switch Basemap Visibility
            if (layerProperties.type === 'base') {
                if (layerProperties.title === newBaseMapTitle) {
                    layer.setVisible(true); 
                } else {
                    layer.setVisible(false); 
                }
            }
        });

        // Part 2: Conditionally Control District Layer Style AND Visibility
        if (newBaseMapTitle === 'Regular Map') {
            districtLayer.setStyle(osmDistrictStyle);
            districtLayer.setVisible(true);
        } else if (newBaseMapTitle === 'Satellite Imagery') {
            districtLayer.setStyle(satelliteDistrictStyle);
            districtLayer.setVisible(true);
        }
    }

    // --- 4. Add Controls (ZoomSlider, FullScreen, ScaleLine, OverviewMap) ---
    map.addControl(new ol.control.ZoomSlider());
    map.addControl(new ol.control.FullScreen());
    map.addControl(new ol.control.ScaleLine());
    map.addControl(new ol.control.OverviewMap());

    // --- 5. Geolocation ("You are here" control) ---
    const geolocation = new ol.Geolocation({
        tracking: false, 
        projection: map.getView().getProjection(),
    });
    geolocation.on('error', function(error) {
        console.log('Geolocation error: ' + error.message);
    });

    const positionFeature = new ol.Feature();
    positionFeature.setStyle(new ol.style.Style({
        image: new ol.style.Circle({
            radius: 6,
            fill: new ol.style.Fill({
                color: '#3399CC',
            }),
            stroke: new ol.style.Stroke({
                color: '#fff',
                width: 2,
            }),
        }),
    }));

    geolocation.on('change:position', function() {
        const coordinates = geolocation.getPosition();
        positionFeature.setGeometry(coordinates ? new ol.geom.Point(coordinates) : null);
        map.getView().setCenter(coordinates);
        map.getView().setZoom(12); 
    });
    
    // Stop tracking when the view is moved by the user
    map.on('pointerdrag', function() {
        geolocation.setTracking(false);
    });

    const vectorSource = new ol.source.Vector({
        features: [positionFeature],
    });
    const vectorLayer = new ol.layer.Vector({
        source: vectorSource,
    });
    map.addLayer(vectorLayer);

    // --- 6. Add the custom Locate Me button control ---
    const locateControl = new ol.control.Control({
        element: document.createElement('div'),
    });
    // CRITICAL: Added 'ol-locate-me' class, defined in style.css
    locateControl.element.className = 'ol-unselectable ol-control ol-locate-me'; 
    const button = document.createElement('button');
    button.innerHTML = '&#x1f4cd;'; // Map pin emoji
    button.title = 'Locate Me';
    button.style.fontSize = '18px';
    button.style.padding = '4px';
    locateControl.element.appendChild(button);
    button.addEventListener('click', function() {
        if (!geolocation.getTracking()) {
             geolocation.setTracking(true); 
        }
    });
    map.addControl(locateControl);
    </script>
</body>
</html>